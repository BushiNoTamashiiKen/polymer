<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../utils/boot.html">
<link rel="import" href="../utils/utils.html">
<link rel="import" href="async.html">

<script>

  /** @constructor */
  Polymer.Debouncer = function Debouncer() {
    this._scheduler = Polymer.Async.microTask;
    this._timer = null;
    this._wait = 0;
    this.flush = this.flush.bind(this);
  };

  Polymer.Utils.mixin(Polymer.Debouncer.prototype, {
    /**
     * Sets the scheduler; that is, a module with the Async interface.
     * This method can optionally receive a wait time if the scheduler supports a wait time
     * and finally returns a reference to itself.
     *
     * @param {{run: function, cancel: function}}
     * @param {number=}
     */
    after(scheduler, wait) {
      this._scheduler = scheduler;
      this._wait = wait;
      return this;
    },

    /**
     * Sets the function callback that will run and the context for that function.
     * Finally, returns a reference to itself.
     *
     * @param {function}
     * @param {Object=}
     */
    run(callback, context) {
      this._callback = context ? callback.bind(context) : callback;
      this._timer = this._scheduler.run(this.flush, this._wait);
      return this;
    },

    /**
     * Cancels an active debouncer and returns a reference to itself.
     */
    cancel() {
      if (this.isActive()) {
        this._scheduler.cancel(this._timer);
        this._timer = null;
      }
      return this;
    },

    /**
     * Flushes an active debouncer and returns a reference to itself.
     */
    flush() {
      if (this.isActive()) {
        this.cancel();
        this._callback();
      }
      return this;
    },

    /**
     * Returns true if the debouncer is active.
     *
     * @return {boolean}
     */
    isActive() {
      return this._timer != null;
    }
  });

  /**
   * Creates a debouncer if no debouncer is passed as a parameter
   * or it cancels an active debouncer otherwise.
   *
   * @param {Polymer.Debouncer?}
   * @return {Polymer.Debouncer}
   */
  Polymer.Debouncer.debounce = function debounce(debouncer) {
    return debouncer instanceof Polymer.Debouncer ? debouncer.cancel() : new Polymer.Debouncer();
  };

</script>
